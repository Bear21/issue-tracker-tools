#! /usr/bin/env python
import click
import sys
import os
import webbrowser
from datetime import date
from typing import List

from jiralib.config import load_jira_config, load_project_config, ReportOptions
from jiralib.jira_ext import JiraServer
from jiralib.report_epics import EpicReport
from jiralib.report_progress import ProgressReport
from jiralib.report_resolved import ResolvedReport
from jiralib.report_issue_detail import IssueDetailReport
from jiralib.report_release_notes import ReleaseNotesReport
from jiralib.report_working import WorkingReport
from jiralib.cumulative_flow_graph import CumulativeFlowGraph


@click.group(context_settings=dict(help_option_names=['-h', '--help']))
@click.option("-v", "--verbose", is_flag=True)
@click.option("-j", "--jira-config",    type=click.Path(exists=True))
@click.option("-p", "--project-config", type=click.Path(exists=True))
@click.pass_context
def jira(ctx: click.Context, verbose: bool, project_config: click.Path, jira_config: click.Path) -> None:
    ctx.obj = build_report_options(verbose, project_config, jira_config)


def build_report_options(verbose: bool, project_config_file: click.Path, jira_config_file: click.Path) -> ReportOptions:
    jira_config_file = jira_config_file or os.path.expanduser("~/jiraconfig.yml")
    if verbose:
        print(f"Using jira config file '{jira_config_file}'")
    jira_config = load_jira_config(jira_config_file)

    project_config_file = project_config_file or jira_config_file
    if verbose:
        print(f"Using project config file '{project_config_file}'")

    project_config = load_project_config(project_config_file)

    return ReportOptions(verbose, project_config, jira_config)


@jira.command()
@click.option("-o", "--open-graph", is_flag=True, default=False, help="Open the graph after generation")
@click.pass_context
def cumulative_flow(ctx: click.Context, open_graph: bool) -> None:
    """Creates a cumulative flow graph from the progress log."""
    csv_file = f"{ctx.obj.report_dir}/{ctx.obj.project_config.project_name}/progress.csv"
    png_file = f"{ctx.obj.report_dir}/{ctx.obj.project_config.project_name}/cfd-{str(date.today())}.png"
    CumulativeFlowGraph(ctx.obj.project_config, csv_file, png_file).run(open_graph)


@jira.command()
@click.option("-s", "--subject", default="")
@click.pass_context
def epic_summary(ctx: click.Context, subject: str) -> None:
    """Report on stories within epics."""
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)
    EpicReport(ctx.obj, jira).run(subject)


def add_fix_version(jira: JiraServer, issue_keys: List[str], new_fix_version: str) -> None:
    for key in issue_keys:
        issue = jira.jira_issue(key)
        if new_fix_version in issue.fix_versions():
            print(f"{issue.key}: already assigned to {new_fix_version}")
        else:
            issue.add_fix_version(new_fix_version)
            print(f"{issue.key}: added version {new_fix_version}")


@jira.command()
@click.option("-o", "--open", is_flag=True, default=False, help="Open issue in a web browser")
@click.option("-f", "--update-fix-version", is_flag=False, type=click.STRING, help="Update issue with specified fix version")
@click.argument("issue_keys", nargs=-1)
@click.pass_context
def issue(ctx: click.Context, open: bool, update_fix_version: str, issue_keys: List[str]) -> None:
    """Report on issue detail."""
    if not issue_keys:
        sys.exit("issue key required")

    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)

    if open:
        webbrowser.open(f"{ctx.obj.jira_config.url}/browse/{issue_keys[0]}")
    elif update_fix_version:
        add_fix_version(jira, issue_keys, update_fix_version)
    else:
        IssueDetailReport(ctx.obj, jira).run(issue_keys)


@jira.command()
@click.option("-g", "--graph", is_flag=True, default=False, help="Generate cumulative flow graph")
@click.argument("label")
@click.pass_context
def progress(ctx: click.Context, graph: bool, label: str) -> None:
    """Report on progress for a project."""
    csv_file = f"{ctx.obj.report_dir}/{label}/progress.csv"
    if graph:
        png_file = f"{ctx.obj.report_dir}/{label}/cfd-{str(date.today())}.png"
    else:
        png_file = None
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)
    ProgressReport(ctx.obj, jira).run(label, csv_file, png_file)


@jira.command()
@click.option("-f", "--fix-version", is_flag=False, type=click.STRING, default=None,
              help="Include all issues with this fix version")
@click.option("-t", "--no-tasks", is_flag=True, default=False, help="Exclude tasks")
@click.option("-m", "--markdown", is_flag=True, default=False, help="Output report as markdown")
@click.argument("issue_keys", nargs=-1)
@click.pass_context
def release(ctx: click.Context, fix_version: str, no_tasks: bool, markdown: bool, issue_keys: List[str]) -> None:
    """Describes a list of tickets as release notes"""
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)

    if fix_version:
        fix_issues = jira.query_fix_version(fix_version)
        issue_keys = [issue.key for issue in fix_issues]

    if not issue_keys:
        sys.exit("issue keys required for release report")

    ReleaseNotesReport(ctx.obj, jira, no_tasks, markdown).run(issue_keys)


@jira.command()
@click.option("-d", "--days", type=click.INT, help="include issues resovled this many days prior to today")
@click.option("-f", "--from", "from_date", type=click.DateTime(formats=["%Y-%m-%d"]),
              help="include resolved issues from this date onwards")
@click.option("-t", "--to",   "to_date",   type=click.DateTime(formats=["%Y-%m-%d"]),
              help="include issues resolved before this date")
@click.pass_context
def resolved(ctx: click.Context, days: int, from_date: click.DateTime, to_date: click.DateTime) -> None:
    """Report on recently closed issues."""
    csv_file = f"{ctx.obj.report_dir}/resolved.csv"
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)

    if from_date:
        from_date = from_date.date()
    if to_date:
        to_date = to_date.date()

    ResolvedReport(ctx.obj, jira).run(days, from_date, to_date, csv_file)


@jira.command()
@click.option("-g", "--group", is_flag=True, default=False, help="Group issues by epic")
@click.pass_context
def working(ctx: click.Context, group: bool) -> None:
    """Report on issues currently in progress."""
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)
    WorkingReport(ctx.obj, jira).run(group)


@jira.command()
@click.argument("label")
@click.pass_context
def epicissues(ctx: click.Context, label: str) -> None:
    """Generate jql to search issues for epics with a given label"""
    jira = JiraServer(ctx.obj.verbose, ctx.obj.jira_config)
    issues = jira.query_jql_issues(f"labels = {label} order by key")
    keys = [issue.key for issue in issues]
    print(f"'Epic Link' in ({', '.join(keys)})")


if __name__ == "__main__":
    jira()
